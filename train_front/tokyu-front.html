<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Tokyu Line</title>
    <style>
      select{
        -webkit-appearance: button;
        -moz-appearance: button;
        appearance: button;
        border-radius:6px;
        width: 100%;
        height: 60px;
        line-height: 60px;
        font-size: 20px;
        text-indent: 2em;
        color: #FFFFFF;
        border: none;
        cursor: pointer;
        background:#888888 url(img/down-arrow.svg) no-repeat;
        background-size:40px 40px;
        background-position: right center;
      }
      button{
        -webkit-appearance: button;
        -moz-appearance: button;
        appearance: button;
        border-radius:6px;
        width: 100%;
        height: 60px;
        line-height: 60px;
        color: #FFFFFF;
        font-size: 20px;
        background:#888888 no-repeat;
        background-size:40px 60px;
      }
      div#container{
        width:100%
      }
      div#toolbox{
        width:20%;
        float: right;
      }
      div#train_image{
        width:80%;
        float: left;
      }
    </style>
    <script type="text/javascript" src="js/jquery-2.1.1.min.js"></script>
    <script>//<![CDATA[
      var tts;
      var kind;
      var station;

      $(document).ready(function(){
        $.getJSON("js/tts.json", function(data){
          tts = data;
        });
        $.getJSON("js/kind.json", function(data){
          kind = data;
        });
        $.getJSON("js/station.json", function(data){
          station = data;
        });
        initCar();
      });
      function getCar() {
        return document.getElementById("train_form").car.value;
      }
      function getLine() {
        var lines = {
          "tokyu-2000-front": "DT",
          "oimachi-line-express-front": "OM",
          "tokyu-8090-front": "OM",
          "tokyu-9000-front": "OM",
          "tokyu-9000-front-80th": "OM"
        };
        return lines[getCar()];
      }
      function getKind() {
        return document.getElementById("train_form").kind.value;
      }
      function getKinds() {
        return {
                     express:     {fgcolor: "white", bgcolor: "red",   string: "急行"},
                     semiexpress: {fgcolor: "white", bgcolor: "lime",  string: "準急"},
                     greenlocal:  {fgcolor: "green", bgcolor: "white", string: "各停"},
                     bluelocal:   {fgcolor: "white", bgcolor: "blue",  string: "各停"},
                     local:       {fgcolor: "white", bgcolor: "black", string: "各停"}
        };
      }
      function getKindString() {
        var kinds = getKinds();
        return kinds[getKind()]["string"];
      }
      function getKindFgColor() {
        var kinds = getKinds();
        return kinds[getKind()]["fgcolor"];
      }
      function getKindBgColor() {
        var kinds = getKinds();
        return kinds[getKind()]["bgcolor"];
      }
      function getDest() {
        return document.getElementById("train_form").dest.value;
      }
      function getDestString() {
        return station[getDest()];
      }
      function getDirection() {
        var direction = {
          "DT27": +1,
          "DT22": +1,
          "DT11": +1,
          "TS03": -1,
          "TI02": -1,
          "TN03": -1,
          "DT14": +1,
          "OM15": +1,
          "OM16": +1,
          "OM01": -1,
          "OM10": -1,
          "Z11":  +1,
          "OM08": +1
        };
        return direction[getDest()];
      }
      function getSource() {
        var source = {
           "OM" : {
             "DT27": "OM01",
             "DT22": "OM01",
             "DT11": "OM01",
             "DT14": "OM01",
             "OM15": "OM01",
             "OM16": "OM01",
             "OM01": "OM16",
             "OM10": "OM01",
             "OM08": "OM01"
          },
          "DT": {
             "DT27": "DT01",
             "DT22": "DT01",
             "DT11": "DT01",
             "TS03": "DT27",
             "TI02": "DT27",
             "TN03": "DT27",
             "Z11":  "DT27",
             "DT14": "DT01"
          } 
        };
        return source[getLine()][getDest()];
      }
      function changeKind() {
        var svg = document.getElementById("train").getSVGDocument();
        if (svg == null) return;

        var kind = getKind();
        svg.getElementById("kind_string").firstChild.firstChild.nodeValue = getKindString();
        svg.getElementById("kind_string").firstChild.style.fill = getKindFgColor();
        svg.getElementById("kind_bg").style.fill = getKindBgColor();
        svg.getElementById("kind_bg").style.stroke = getKindFgColor();
        svg.getElementById("kind_bg").style.strokeWidth = 3;
        svg.getElementById("kind_bg").style.strokeDashArray = 20;
      }
      function changeDest() {
        var svg = document.getElementById("train").getSVGDocument();
        if (svg == null) return;
        var dest = getDestString();
        svg.getElementById("dest_string").firstChild.firstChild.nodeValue = dest;
        var fontSize = 40 / dest.length * 3;
        svg.getElementById("dest_string").firstChild.style.fontSize = fontSize;
      }
      function moveWiper() {
        var svg = document.getElementById("train").getSVGDocument();
        var wipe = '<animateMotion path="M10,0 100,0 10,0" dur="1s" repeatCount="indefinite" />';
        svg.getElementById("wiper").innerHTML = wipe;
      }
      function changeCar() {
        var car = document.getElementById("train_form").car.value;
        document.getElementById("train").setAttribute("src", car + ".svg");
        document.getElementById("train").style.display = "none";
        document.getElementById("train").style.display = "block";
        initCar();
      }
      function initCar() {
        var car = document.getElementById("train_form").car.value;
        document.getElementById("train").setAttribute("src", car + ".svg");
        document.getElementById("train").onload = initCar;
        changeKind();
        changeDest();
        //moveWiper();
      }
      function playSound(sound) {
        var audio = new Audio("audio/"+ sound + ".mp3");
        audio.play();
      }
      function playSounds(snd) {
        sounds = snd;
        current = 0 ;
        var audio = new Audio("audio/"+ sounds[current] + ".mp3");
        audio.play();

        audio.addEventListener('ended',function(e){
          current++;
          if(current < sounds.length) {
            source = "audio/" + sounds[current] + ".mp3";
            this.src = source
            this.pause();
            this.load();
            this.play();
          }
        });
      }
      function findStation(station){
        var index = 0;
        order.forEach(function(value, i) {
          if(value["station"] == station) {
            index = i;
            return;
          }
        });
        return index;
      }
      var order = new Array();
      var preLineKind = '';
      var next = 0;
      var isSoon = false;
      function sayNext() {
        var lineKind = getLine() + "_" + getKind();
        if(lineKind != preLineKind || order.length == 0)  {
          preLineKind = lineKind;
          $.getJSON("js/"+ lineKind + ".json", function(data){
            order = data;
            next = findStation(getSource());
            sayNext();
          });
        };
        if(order.length > 0){
          if(next < 0){
            next = findStation(getSource());
          };
          if(next >= order.length){
            next = findStation(getSource());
          };
          if(next == 0 && ( getDest() != order[next]["station"] )){
            var message = ["kind_general_lead","kind_" + getKind(), getDest(), "dest_general_trail"];
            playSounds(message);
            next += getDirection();
            return;
          };
          if(isSoon) {
            if(order[next]["change"]) {
              playSounds(["soon_lead", order[next]["station"], "soon_trail",
                         order[next]["change"],"change_tail"]);
            } else {
              playSounds(["soon_lead", order[next]["station"], "soon_trail"]);
            };
            if(getDest() == order[next]["station"]){
              next = findStation(getSource());;
              return;
            };
            next += getDirection();
          } else {
            playSounds(["next_lead", order[next]["station"], "next_trail"]);
          };
          isSoon = isSoon ? false : true;
        };
      }
      //]]>
    </script>
  </head>
  <body>
    <div id="container">
      <div id="toolbox">
        <form id="train_form">
          <select name="car" onchange="changeCar()">
            <option value="tokyu-2000-front" selected="slected">2000系</option>
            <option value="oimachi-line-express-front">6000系</option>
            <option value="tokyu-8090-front">8090系</option>
            <option value="tokyu-9000-front">9000系</option>
            <option value="tokyu-9000-front-80th">9000系(80周年)</option>
          </select>
          <select name="kind" onchange="changeKind()">
            <option value="express">急行</option>
            <option value="semiexpress" selected="slected">準急</option>
            <option value="greenlocal">各停</option>
            <option value="bluelocal">各停</option>
            <option value="local">各停</option>
          </select>
          <select name="dest" onchange="changeDest()">
            <option value="DT27" selected="slected">中央林間</option>
            <option value="DT22">長津田</option>
            <option value="DT11">梶が谷</option>
            <option value="TS03">押上</option>
            <option value="TI02">久喜</option>
            <option value="TN03">南栗橋</option>
            <option value="DT14">鷺沼</option>
            <option value="OM15">二子玉川</option>
            <option value="OM16">溝の口</option>
            <option value="OM01">大井町</option>
            <option value="OM10">自由が丘</option>
            <option value="Z11">清澄白河</option>
            <option value="OM08">大岡山</option>
          </select>
          <br>
          <button type="button" name="slow_train" value="slow_train" onclick="playSound(this.value)">ゆっくり走る</button>
          <button type="button" name="fast_train" value="fast_train" onclick="playSound(this.value)">速く走る</button>
          <button type="button" name="crossing" value="crossing" onclick="playSound(this.value)">踏切</button>
          <button type="button" name="close" value="close" onclick="playSound(this.value)">close</button>
          <button type="button" name="open" value="open" onclick="playSound(this.value)">open</button>
          <button type="button" name="say_next" value="" onclick="sayNext()">つぎ</button>
          <button type="button" name="say_next" value="" onclick="moveWiper()">ワイパー</button>
        </form>
      </div>
      <div id="train_image">
        <embed src="tokyu-2000-front.svg" type="image/svg+xml" id="train"/>
      </div>
      <div style="display: none" id="audios"></div>
    </div>
    <div><a href="http://www.senses-circuit.com/">音源：フリー音楽素材 Senses Circuit</a></div>
    <div><a href="http://open-jtalk.sourceforge.net/">音声：Open JTalk</a></div>
  </body>
</html>
